{% extends "partials/_auth_layout.html" %}
{% load i18n json_script %}

{% block auth_title %}{% trans "Vérifie ta boîte mail" %}{% endblock %}

{% block auth_form %}
  <div id="reset-status-message" class="alert success" aria-live="polite">
    {% trans "Si l’adresse existe, un e‑mail a été envoyé avec les étapes à suivre." %}
  </div>

  <div id="reset-countdown" class="reset-countdown" aria-live="polite"></div>

  <div class="meta-links">
    <a href="{% url 'pages:login' %}">{% trans "Retour à la connexion" %}</a>
  </div>

  {% if reset_flow.flow_id %}
    {{ reset_flow|json_script:"password-reset-flow" }}
  {% else %}
    {{ {"flow_id": "", "state": "noop"}|json_script:"password-reset-flow" }}
  {% endif %}

  <script>
    (function () {
      const container = document.getElementById('password-reset-flow');
      if (!container) {
        return;
      }
      const flowData = JSON.parse(container.textContent);
      const statusUrl = "{{ status_url|default:''|escapejs }}";
      if (!flowData.flow_id || !statusUrl) {
        return;
      }

      const messageEl = document.getElementById('reset-status-message');
      const countdownEl = document.getElementById('reset-countdown');
      let countdownTimer = null;

      function formatDelay(targetIso) {
        if (!targetIso) {
          return null;
        }
        const target = new Date(targetIso);
        const now = new Date();
        const diffMs = target.getTime() - now.getTime();
        if (diffMs <= 0) {
          return null;
        }
        const totalSeconds = Math.round(diffMs / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return { minutes, seconds, totalSeconds };
      }

      function renderCountdown(delay) {
        if (!countdownEl) {
          return;
        }
        if (!delay) {
          countdownEl.textContent = '';
          return;
        }
        countdownEl.textContent = `⏱️ {% trans "Nouvelle tentative dans" %} ${String(delay.minutes).padStart(2, '0')}:${String(delay.seconds).padStart(2, '0')}`;
      }

      function renderState(state, nextEta, issueCode) {
        if (!messageEl) {
          return;
        }
        if (state === 'sent') {
          messageEl.textContent = '{% trans "C’est tout bon ! Si l’adresse existe, l’e-mail vient d’être envoyé." %}';
          renderCountdown(null);
        } else if (state === 'suppressed') {
          const reason = issueCode === 'bounce_limit'
            ? '{% trans "Notre fournisseur limite temporairement les envois. Réessaie dans une heure." %}'
            : '{% trans "L’envoi a échoué après plusieurs tentatives. Contacte le support si besoin." %}';
          messageEl.textContent = reason;
          renderCountdown(null);
        } else if (state === 'retrying') {
          messageEl.textContent = '{% trans "Nous réessaierons automatiquement dans quelques minutes." %}';
          renderCountdown(formatDelay(nextEta));
        } else {
          messageEl.textContent = '{% trans "Nous préparons l’envoi de ton e‑mail sécurisé." %}';
          renderCountdown(null);
        }
      }

      function applyStatus(payload) {
        renderState(payload.state, payload.next_attempt_eta, payload.issue_code);
        flowData.state = payload.state;
        flowData.next_attempt_eta = payload.next_attempt_eta;
        if (countdownTimer) {
          clearInterval(countdownTimer);
        }
        if (payload.state === 'retrying' && payload.next_attempt_eta) {
          countdownTimer = setInterval(function () {
            const delay = formatDelay(payload.next_attempt_eta);
            renderCountdown(delay);
            if (!delay) {
              clearInterval(countdownTimer);
              countdownTimer = null;
            }
          }, 1000);
        }
      }

      applyStatus(flowData);

      function poll() {
        fetch(statusUrl, { headers: { 'Accept': 'application/json' } })
          .then(function (response) { return response.json(); })
          .then(function (payload) {
            applyStatus(payload);
            if (payload.state === 'sent' || payload.state === 'suppressed') {
              return;
            }
            setTimeout(poll, 10000);
          })
          .catch(function () {
            setTimeout(poll, 15000);
          });
      }

      if (flowData.state !== 'sent' && flowData.state !== 'suppressed') {
        setTimeout(poll, 8000);
      }
    })();
  </script>
{% endblock %}
