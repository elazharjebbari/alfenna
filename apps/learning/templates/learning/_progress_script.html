<script>
(function(){
  const video = document.getElementById('lecture-video');
  if (!video) return;

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  }
  const csrftoken = getCookie('csrftoken');

  let lastSent = 0;
  function sendProgress(ms, completed) {
    const now = Date.now();
    if (now - lastSent < {{ throttle_ms|default:3000 }}) return;
    lastSent = now;
    fetch("{% url 'learning:progress' lecture.id %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken },
      body: new URLSearchParams({ position_ms: String(ms|0), completed: completed ? "1" : "" })
    }).catch(()=>{});
  }

  video.addEventListener('timeupdate', function(){
    const ms = video.currentTime * 1000;
    sendProgress(ms, false);
  });

  video.addEventListener('ended', function(){
    sendProgress(video.duration * 1000, true);
  });
})();
</script>
