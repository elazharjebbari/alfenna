{% load i18n static %}
{% get_current_language as LANGUAGE_CODE %}

{# ==== RTL ==== #}
{% if LANGUAGE_CODE == 'ar' %}
    <style>
        .ul-product-details-rating {
            text-align: right;
            direction: rtl;
        }

        .ul-product-details-options.rtl {
            direction: rtl;
        }

        .ul-product-details-options.rtl .title {
            text-align: right;
            display: block;
            margin-bottom: .5rem;
        }

        .ul-product-details-options.rtl .variants {
            display: flex;
            flex-direction: row-reverse;
            gap: .5rem;
            justify-content: flex-start;
        }

        .ul-product-details-options.rtl .badge {
            font-size: 1rem;
            direction: rtl;
            display: inline-block;
        }

        form[dir="rtl"] {
            direction: rtl !important;
        }

        form[dir="rtl"] .form-control, form[dir="rtl"] input, form[dir="rtl"] textarea {
            text-align: right !important;
        }

        form[dir="rtl"] .input-group {
            flex-direction: row-reverse !important;
        }

        form[dir="rtl"] .input-group .input-group-text {
            text-align: right !important;
        }
    </style>
{% endif %}

<style>
    #product-media-col, #product-info-col {
        min-width: 0;
    }

    #product-media-col .ul-product-details-img {
        max-width: none;
        width: 100%;
    }

    #product-hero .hero-media {
        background: #f6f6f6;
        position: relative;
    }

    #product-hero .hero-nav {
        position: absolute;
        inset: 0;
        pointer-events: none;
    }

    #product-hero .btn-hero {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        inline-size: 48px;
        block-size: 48px;
        border-radius: 999px;
        display: grid;
        place-items: center;
        border: 0;
        pointer-events: auto;
        background: rgba(255, 255, 255, .92);
        box-shadow: 0 6px 14px rgba(0, 0, 0, .12);
        cursor: pointer;
    }

    #product-hero .btn-prev {
        inset-inline-start: .5rem;
    }

    #product-hero .btn-next {
        inset-inline-end: .5rem;
    }

    #product-hero .btn-hero:focus-visible {
        outline: 3px solid var(--bs-primary);
    }

    #product-hero .thumbs {
        display: flex;
        gap: .5rem;
        align-items: center;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        padding-bottom: .25rem;
    }

    #product-hero .thumbs::-webkit-scrollbar {
        display: none;
    }

    #product-hero .thumb {
        inline-size: 92px;
        block-size: 68px;
        flex: 0 0 auto;
        position: relative;
        outline: none;
    }

    #product-hero .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: .75rem;
        display: block;
    }

    #product-hero .thumb--selected::after {
        content: "";
        position: absolute;
        inset: 0;
        border: 2px solid var(--bs-primary);
        border-radius: .75rem;
        box-shadow: 0 0 0 2px #fff inset;
    }

    #product-hero .thumb:focus-visible {
        outline: 3px solid var(--bs-primary);
        outline-offset: 2px;
    }

    @media (min-width: 992px) {
        #product-media-col .hero-media {
            aspect-ratio: 4/3;
        }

        #product-media-col .thumb {
            inline-size: 112px;
            block-size: 84px;
        }
    }

    .ul-product-details-price-helper {
        font-size: .78rem;
        margin-top: -.7rem;
    }

    .badge-list {
        display: flex;
        flex-wrap: wrap;
        gap: .5rem .75rem;
        align-items: center;
    }

    .badge-list .badge {
        background: rgba(13, 110, 253, .08);
        color: #0d6efd;
        font-weight: 500;
    }

    .lp-form-card {
        background: #fff;
        border: 1px solid #f4c6cc; /* rose pâle cohérent */
        border-radius: 16px;
        padding: 1rem;
        box-shadow: 0 10px 24px rgba(0, 0, 0, .06);
    }

    html[lang="ar"] .lp-form-card {
        direction: rtl;
        text-align: right;
    }

    .wa-quick-link {
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        font-weight: 800;
        color: #0b8a6a;
        text-decoration: none;
    }

    .wa-quick-link:hover {
        text-decoration: underline
    }

    .wa-quick-link .ic {
        font-size: 1rem;
        line-height: 1
    }

</style>

<div class="ul-inner-page-container">
    <div class="ul-product-details">
        <div class="ul-product-details-top">
            <div class="row g-4 g-lg-5 align-items-start">

                <!-- MEDIA -->
                <div class="col-12 col-lg-7" id="product-media-col">
                    <div class="ul-product-details-img" id="product-hero" data-gallery="{{ lp.slug }}">

                        {% static 'carpet/images/cover/cadre-domestique.webp' as DEFAULT_HERO %}
                        {% trans "Tapis Sajadat Al-Raha — coussin mémoire intégré" as DEFAULT_ALT %}

                        {% with images=variant.media_list img=images|first %}
                            {% with first_src=img.src|default:DEFAULT_HERO first_alt=img.alt|default:DEFAULT_ALT %}

                                <figure class="hero-media ratio ratio-4x3 rounded-4 overflow-hidden mb-2">
                                    <a id="hero-link" href="{{ first_src }}" data-fslightbox="product-hero">
                                        <picture id="hero-picture">
                                            <source id="hero-src-webp" type="image/webp" srcset="{{ first_src }}">
                                            <img id="hero-img" width="1200" height="900"
                                                 class="w-100 h-100 object-fit-cover"
                                                 fetchpriority="high" loading="eager" decoding="async"
                                                 src="{{ first_src }}" alt="{{ first_alt }}">
                                        </picture>
                                    </a>

                                    <!-- Flèches -->
                                    <div class="hero-nav" aria-hidden="false">
                                        <button type="button" class="btn-hero btn-prev"
                                                aria-label="{% trans 'Image précédente' %}">
                                            <i class="flaticon-left-arrow"></i>
                                        </button>
                                        <button type="button" class="btn-hero btn-next"
                                                aria-label="{% trans 'Image suivante' %}">
                                            <i class="flaticon-arrow-point-to-right"></i>
                                        </button>
                                    </div>
                                </figure>

                            {% endwith %}

                            {% if images %}
                                <div class="thumbs {% if LANGUAGE_CODE == 'ar' %}flex-row-reverse{% endif %} mb-3"
                                     role="tablist" aria-label="{% trans 'Images du produit' %}">
                                    {% for m in images %}
                                        <button type="button"
                                                class="thumb btn p-0 border-0 rounded-3 {% if forloop.first %}thumb--selected{% endif %}"
                                                role="tab"
                                                aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
                                                aria-controls="hero-img" data-index="{{ forloop.counter0 }}"
                                                data-full="{{ m.src }}" data-alt="{{ m.alt|default_if_none:'' }}">
                                            <img width="140" height="105" loading="lazy" src="{{ m.src }}" alt="">
                                        </button>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endwith %}

                    </div>
                </div>


                <!-- INFO -->
                <div class="col-12 col-lg-5" id="product-info-col" {% if LANGUAGE_CODE == 'ar' %}dir="rtl"{% endif %}>
                    <div class="ul-product-details-txt">

                        <div class="ul-product-details-rating">
              <span class="rating">
                <i class="flaticon-star"></i><i class="flaticon-star"></i><i class="flaticon-star"></i>
                <i class="flaticon-star"></i><i class="flaticon-star"></i>
              </span>
                            <span class="review-number"></span>
                        </div>


                        <span class="ul-product-details-price d-inline-flex align-items-baseline gap-2">
                          <span class="fw-bold text-danger fs-4">
                            {{ product.promotion_price|floatformat:0 }} {% trans 'MAD' %}
                          </span>
                            {% if product.price and product.price > product.promotion_price %}
                                <span class="text-muted text-decoration-line-through fs-6">
                              {{ product.price|floatformat:0 }} {% trans 'MAD' %}
                            </span>
                            {% endif %}
                        </span>

                        <small class="d-block text-success opacity-75 ul-product-details-price-helper">
                            {% trans "Livraison gratuite partout au Maroc" %}
                        </small>

                        <div class="mt-1">
                            <a id="wa-quick-buy" class="wa-quick-link" href="#" target="_blank" rel="noopener" data-event="whatsapp_checkout_click">
                                <span class="ic"><i class="fab fa-whatsapp" aria-hidden="true"></i></span>
                                {% trans "Commander sur WhatsApp (rapide)" %}
                            </a>
                        </div>

                        {% if price_ui.show %}
                            <small class="d-block text-success ul-product-details-savings-helper">
                                {% trans "Vous économisez" %} {{ price_ui.savings_text }} ({{ price_ui.percent_text }})
                            </small>
                        {% endif %}



                        <h1 class="ul-product-details-title h3 mt-2">{% trans "Sajadat Al-Raha – Tapis de prière confortable et élégant" %}</h1>

                        {#                        {% if variant.badges %}#}
                        {#                            <div class="badge-list my-2">#}
                        {#                                {% for b in variant.badges|slice:":5" %}#}
                        {#                                    <span class="badge rounded-pill px-3 py-2">{{ b }}</span>#}
                        {#                                {% endfor %}#}
                        {#                            </div>#}
                        {#                        {% elif variant.subline %}#}
                        {#                            <p class="text-muted">{{ variant.subline }}</p>#}
                        {#                        {% endif %}#}

                        <p class="ul-product-details-descr">
                            {% trans "Conçu pour allier confort et spiritualité, ce tapis de prière ergonomique soulage vos genoux et apporte une sérénité nouvelle à vos moments de recueillement. Idéal pour les adultes, seniors, ou personnes souffrant de douleurs articulaires." %}
                        </p>

                        <div class="ul-product-details-options {% if LANGUAGE_CODE == 'ar' %}rtl{% endif %}">
                            <div class="ul-product-details-option ul-product-details-sizes">
                                <span class="title">{% trans "Taille" %}</span>
                                <form action="#" class="variants" {% if LANGUAGE_CODE == 'ar' %} dir="rtl" {% endif %}>
                                    <label for="size-unique" class="d-inline-block">
                                        <input type="radio" name="product-size" id="size-unique" checked hidden>
                                        <span class="badge bg-primary">{% trans "120 cm x 72 cm" %}</span>
                                    </label>
                                </form>
                            </div>
                        </div>

                        <div id="order" class="lp-form-card mt-3">
                            {% include 'carpet/components/forms/forms-upsell/3_v2.html' %}
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var heroImg = document.getElementById('hero-img');
        var heroLink = document.getElementById('hero-link');
        var srcWebp = document.getElementById('hero-src-webp');
        var thumbsBox = document.querySelector('#product-hero .thumbs');
        var btnPrev = document.querySelector('#product-hero .btn-prev');
        var btnNext = document.querySelector('#product-hero .btn-next');
        if (!heroImg || !thumbsBox) return;

        var thumbs = Array.prototype.slice.call(thumbsBox.querySelectorAll('.thumb'));

        function selectThumb(btn) {
            var full = btn.getAttribute('data-full');
            var alt = btn.getAttribute('data-alt') || heroImg.alt;
            if (srcWebp) srcWebp.srcset = full;
            heroImg.src = full;
            heroImg.alt = alt;
            heroLink.href = full;

            thumbs.forEach(function (t) {
                t.classList.remove('thumb--selected');
                t.setAttribute('aria-selected', 'false');
            });
            btn.classList.add('thumb--selected');
            btn.setAttribute('aria-selected', 'true');
            try {
                btn.scrollIntoView({block: 'nearest', inline: 'center', behavior: 'smooth'});
            } catch (e) {
            }
            try {
                (window.dataLayer = window.dataLayer || []).push({event: 'product_media_switch', src: full});
            } catch (e) {
            }
        }

        function currentIndex() {
            var cur = thumbsBox.querySelector('.thumb.thumb--selected');
            return cur ? parseInt(cur.getAttribute('data-index') || thumbs.indexOf(cur), 10) : 0;
        }

        function selectByIndex(i) {
            var idx = (i + thumbs.length) % thumbs.length;
            selectThumb(thumbs[idx]);
        }

        thumbsBox.addEventListener('click', function (e) {
            var b = e.target.closest('.thumb');
            if (b) selectThumb(b);
        });
        thumbsBox.addEventListener('keydown', function (e) {
            var i = currentIndex();
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                selectByIndex(i + 1);
            }
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                selectByIndex(i - 1);
            }
        });
        if (btnPrev) btnPrev.addEventListener('click', function () {
            selectByIndex(currentIndex() - 1);
        });
        if (btnNext) btnNext.addEventListener('click', function () {
            selectByIndex(currentIndex() + 1);
        });

        try {
            (window.dataLayer = window.dataLayer || []).push({
                event: 'lp_variant_view',
                lp_slug: "{{ lp.slug }}",
                vp_key: "{{ variant.key }}",
                vp_lang: "{{ variant.language }}"
            });
        } catch (e) {
        }
    });
</script>

<script>
    (function () {
        const waBtn = document.getElementById('btn-wa-buy');
        if (!waBtn) return;

        // ► numéro WhatsApp (mets-le aussi en variable de contexte si tu veux)
        const WA_NUMBER = "{{ WA_NUMBER|default:'212625113848' }}";

        function getSel() {
            const r = document.querySelector('.offer-radio:checked');
            if (!r) return null;
            return {
                key: r.value,
                qty: Number(r.dataset.qty || 1),
                price: Number((r.dataset.price || "0").toString().replace(',', '.')),
                label: r.dataset.label || ''
            };
        }

        function getBasics() {
            return {
                productId: document.getElementById('product_id')?.value || '',
                productName: document.getElementById('product_name')?.value || '',
                lang: "{{ LANGUAGE_CODE|default:'fr' }}"
            };
        }

        function getUser() {
            return {
                name: document.getElementById('firstname')?.value?.trim() || '',
                phone: document.getElementById('phone-number')?.value?.trim() || '',
                addr: document.getElementById('address')?.value?.trim() || ''
            };
        }

        // Message bilingue (FR/AR) simple et robuste
        function buildMessage() {
            const sel = getSel() || {key: '', qty: 1, price: 0, label: ''};
            const {productName, lang} = getBasics();
            const u = getUser();

            if (lang.startsWith('ar')) {
                return `سلام، بغيت نطلب:
                • ${productName}
                • العرض: ${sel.label || sel.key} (x${sel.qty})
                • الثمن: ${sel.price} درهم`;
            }
            return `Bonjour, je souhaite commander :
                • ${productName}
                • Offre : ${sel.label || sel.key} (x${sel.qty})
                • Prix : ${sel.price} MAD`;
        }

        function buildWaUrl() {
            const msg = buildMessage();
            return `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(msg)}`;
        }

        // Met le href à jour quand l’offre ou les champs changent
        function refreshHref() {
            waBtn.setAttribute('href', buildWaUrl());
        }

        ['change', 'input'].forEach(ev => {
            document.addEventListener(ev, (e) => {
                if (
                    e.target.closest('.offer') ||   // changement d’offre
                    e.target.id === 'firstname' ||
                    e.target.id === 'phone-number' ||
                    e.target.id === 'address'
                ) {
                    refreshHref();
                }
            });
        });
        refreshHref();

    })();

    // --- C1 : lien WA sous le prix ---
    (function () {
        const link = document.getElementById('wa-quick-buy');
        if (!link) return;

        const WA_NUMBER = "{{ WA_NUMBER|default:'212630035905' }}";
        const productName = "{{ product.name|default:_('Sajadat Al-Raha – Tapis de prière') }}";
        const lang = "{{ LANGUAGE_CODE|default:'fr' }}";

        function getSel() {
            const r = document.querySelector('.offer-radio:checked');
            if (!r) return {
                key: 'solo',
                qty: 1,
                price: Number(("{{ product.promotion_price|default:0 }}").toString().replace(',', '.')),
                label: 'Solo'
            };
            return {
                key: r.value,
                qty: Number(r.dataset.qty || 1),
                price: Number((r.dataset.price || "0").toString().replace(',', '.')),
                label: r.dataset.label || '—'
            };
        }

        function msg() {
            const s = getSel();
            if (lang.startsWith('ar')) {
                return `سلام، بغيت نطلب:
• ${productName}
• العرض: ${s.label} (x${s.qty})
• الثمن: ${s.price} درهم`;
            }
            return `Bonjour, je souhaite commander :
• ${productName}
• Offre : ${s.label} (x${s.qty})
• Prix : ${s.price} MAD`;
        }

        function refresh() {
            link.setAttribute('href', `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(msg())}`);
        }

        refresh();

        // Si l’utilisateur change d’offre dans Step 1
        document.addEventListener('change', (e) => {
            if (e.target && e.target.classList.contains('offer-radio')) refresh();
        });
    })();

</script>

