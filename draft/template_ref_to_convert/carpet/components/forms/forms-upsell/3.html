{% load i18n static widget_tweaks pricing humanize l10n %}

<style>
    /* ===== Tokens : charte + sémantique ===== */
    :root {
        --black: #000;
        --white: #fff;
        --ul-primary: #EF2853; /* rouge marque */
        --ul-secondary: #FFA31A; /* orange marque */
        --ul-gradient: linear-gradient(90deg, var(--ul-primary) 0%, var(--ul-secondary) 100%);
        --font-primary: "Jost", sans-serif;
    }

    .lp-form {
        font-family: var(--font-primary);

        /* Charte */
        --brand: var(--ul-primary);
        --brand-weak: rgba(239, 40, 83, .08);
        --accent-grad: var(--ul-gradient); /* CTA / sélection */
        --accent-solid: var(--ul-primary);

        /* Sémantique UX */
        --info: #1677ff; /* Bleu (repères, focus, liens)   */
        --success: #10b981; /* Vert (économies, rassurance)    */
        --warning: #f59e0b; /* Orange (astuce/avis)            */
        --danger: #ef4444; /* Rouge (erreurs)                 */

        --text: #0f172a;
        --muted: #64748b;
        --surface: #fff;
        --line: #e7e7ea;
        --shadow: 0 8px 20px rgba(2, 6, 23, .08);
        --radius: 16px;
    }

    /* ===== CTA ===== */
    .lp-form .btn-cta {
        width: 100%;
        padding: .95rem 1rem;
        border: 0;
        border-radius: 12px;
        background: var(--accent-grad);
        color: #fff;
        font-weight: 800;
        font-size: 1rem;
        line-height: 1.1;
        box-shadow: 0 6px 14px rgba(239, 40, 83, .18);
    }

    .lp-form .btn-cta:hover {
        filter: brightness(.98) saturate(1.05)
    }

    .lp-form .btn-cta:focus-visible {
        outline: 3px solid rgba(22, 119, 255, .35);
        outline-offset: 2px
    }

    .step {
        display: none
    }

    .step.is-active {
        display: block
    }

    /* ===== Indispo ===== */
    .unavailable {
        display: flex;
        gap: .8rem;
        align-items: center;
        line-height: 1.35;
        background: linear-gradient(180deg, #fff6f6 0%, #ffe9e9 100%);
        border: 1px solid #ffd3d3;
        border-radius: 12px;
        padding: .8rem 1rem;
        color: #b80606;
        font-weight: 700
    }

    /* ===== Étape 1 : Offres ===== */
    .step1-title {
        font-weight: 900;
        font-size: 1.15rem;
        margin: .2rem 0 .6rem;
        text-align: center
    }

    .offers {
        display: grid;
        gap: .8rem
    }

    .offer {
        display: block
    }

    .offer input[type=radio] {
        position: absolute;
        opacity: 0;
        pointer-events: none
    }

    .offer-card {
        position: relative;
        display: grid;
        grid-template-columns:auto 1fr;
        gap: .85rem;
        padding: 1rem .95rem;
        border: 2px solid var(--line);
        border-radius: var(--radius);
        background: var(--surface);
        transition: border-color .15s ease, box-shadow .15s ease, background-color .15s ease
    }

    .offer-card.is-pack {
        border-color: rgba(239, 40, 83, .16)
    }

    .offer-ic {
        inline-size: 40px;
        block-size: 40px;
        border-radius: 10px;
        display: grid;
        place-items: center;
        background: rgba(22, 119, 255, .08);
        color: var(--info);
        font-size: 1.1rem;
        align-self: flex-start
    }

    .offer-txt {
        display: grid;
        gap: .25rem;
        align-content: start
    }

    .offer-title {
        font-weight: 700;
        font-size: .98rem;
        color: var(--text)
    }

    .offer-price {
        display: flex;
        gap: .5rem;
        align-items: baseline
    }

    .offer-price .now {
        font-weight: 800;
        font-size: 1.05rem;
        color: #111
    }

    .offer-price .was {
        color: #9aa1a8;
        text-decoration: line-through;
        font-size: .92rem
    }

    /* Économies = vert */
    .offer-save {
        font-size: .85rem;
        font-weight: 700;
        color: var(--success);
        display: flex;
        gap: .35rem;
        align-items: center
    }

    .offer-unit {
        font-size: .8rem;
        color: var(--muted)
    }

    /* Survol / focus */
    .offer-card:hover {
        border-color: #ffc9d4;
        background: linear-gradient(180deg, #fff 0%, #fff8f6 100%)
    }

    .offer input.offer-radio:focus-visible + .offer-card {
        box-shadow: 0 0 0 .2rem rgba(22, 119, 255, .18)
    }

    /* Sélection */
    .offer-check {
        position: absolute;
        inset-inline-end: .65rem;
        top: .65rem;
        inline-size: 26px;
        block-size: 26px;
        border-radius: 999px;
        display: grid;
        place-items: center;
        border: 2px solid #cbd5e1;
        background: #fff;
        transition: all .15s ease
    }

    .offer-check svg {
        inline-size: 16px;
        block-size: 16px;
        display: none
    }

    .offer input.offer-radio:checked + .offer-card {
        border-color: var(--brand);
        background: linear-gradient(180deg, #fff 0%, rgba(239, 40, 83, .04) 100%);
        box-shadow: var(--shadow), 0 0 0 .18rem rgba(239, 40, 83, .12)
    }

    .offer input.offer-radio:checked + .offer-card .offer-check {
        background: var(--brand);
        border-color: var(--brand)
    }

    .offer input.offer-radio:checked + .offer-card .offer-check svg {
        display: block;
        color: #fff;
        fill: #fff
    }

    .offer input.offer-radio:checked + .offer-card::before {
        content: "";
        position: absolute;
        inset-inline-start: -2px;
        top: -2px;
        bottom: -2px;
        width: 4px;
        border-start-start-radius: calc(var(--radius) - 2px);
        border-end-start-radius: calc(var(--radius) - 2px);
        background: var(--ul-gradient)
    }

    .offer-badge {
        position: absolute;
        inset-inline-end: .65rem;
        bottom: .2rem;
        padding: .2rem .2rem;
        border-radius: 10px;
        background: var(--accent-solid);
        color: #fff;
        font-size: .7rem;
        font-weight: 800;
        display: flex;
        gap: .35rem;
        align-items: center;
        box-shadow: 0 4px 10px rgba(239, 40, 83, .2);
        pointer-events: none
    }

    /* ===== Étape 2 ===== */
    .lp-form .grid {
        display: grid;
        gap: .65rem
    }

    @media (min-width: 992px) {
        .lp-form .grid {
            grid-template-columns:1fr 1fr
        }

        .lp-form .grid .span-2 {
            grid-column: 1/-1
        }
    }

    .field {
        display: flex;
        flex-direction: column;
        gap: .35rem
    }

    .field label {
        font-size: .92rem;
        font-weight: 800;
        color: #0f172a
    }

    .pill {
        position: relative;
        display: flex;
        align-items: center;
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 12px;
        min-height: 56px;
        padding: .75rem 1rem .75rem 2.6rem;
        transition: border-color .15s ease, box-shadow .15s ease
    }

    .pill:focus-within {
        border-color: var(--info);
        box-shadow: 0 0 0 .2rem rgba(22, 119, 255, .15)
    }

    .pill.is-invalid {
        border-color: var(--danger);
        box-shadow: 0 0 0 .2rem rgba(239, 68, 68, .12)
    }

    .pill input {
        width: 100%;
        border: 0;
        background: transparent;
        color: #111;
        font-size: 1rem
    }

    .pill .icon {
        position: absolute;
        inset-inline-start: .9rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.1rem;
        color: var(--info)
    }

    /* Récap : bandeau gradient pour ancrer la marque */
    .recap {
        display: flex;
        align-items: center;
        gap: .6rem;
        border-radius: 12px;
        background: #fff;
        border: 1px solid var(--line);
        color: #0f172a;
        font-weight: 800;
        padding: .65rem .8rem;
        margin: .4rem 0;
        position: sticky;
        top: .5rem;
        z-index: 5
    }

    .recap:before {
        content: "";
        display: block;
        inline-size: 4px;
        block-size: 100%;
        border-radius: 8px 0 0 8px;
        margin-inline-end: .6rem;
        background: var(--ul-gradient)
    }

    .recap .ic {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: rgba(22, 119, 255, .12);
        color: var(--info);
        display: grid;
        place-items: center
    }

    .recap .link-back {
        margin-inline-start: auto;
        color: var(--info);
        font-weight: 700;
        text-decoration: underline dotted
    }

    .recap .link-back:hover {
        text-decoration: underline
    }

    .help {
        color: #64748b;
        font-size: .88rem;
        margin: .25rem 0 0
    }

    .reassure-line {
        display: flex;
        flex-wrap: wrap;
        gap: .5rem .75rem;
        align-items: center;
        justify-content: flex-start
    }

    .reassure-item {
        display: inline-flex;
        align-items: center;
        gap: .375rem;
        padding: .38rem .65rem;
        border-radius: 999px;
        background: rgba(16, 185, 129, .12);
        color: var(--success);
        font-weight: 700;
        font-size: .9rem
    }

    /* RTL */
    html[lang="ar"] .offer input.offer-radio:checked + .offer-card::before {
        inset-inline-start: auto;
        inset-inline-end: -2px
    }
</style>

<form id="lead-form" method="post" class="lp-form"
      novalidate {% if LANGUAGE_CODE == 'ar' %}dir="rtl"{% endif %}
      data-has-offers="{% if offers %}1{% else %}0{% endif %}">
    {% csrf_token %}
    {{ form.product }}{{ form.promotion_selected }}

    {% if not product or not offers %}
        <!-- ===== Indisponible ===== -->
        <div class="unavailable" role="alert" aria-live="polite">
            <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
            <span>{% trans "Produit indisponible pour le moment. Revenez plus tard." %}</span>
        </div>
        <button type="button" class="btn-cta mt-2" disabled aria-disabled="true">
            <i class="fas fa-ban" aria-hidden="true"></i> {% trans "Indisponible" %}
        </button>
        <input type="hidden" id="offer_key" name="offer_key" value="">
        <input type="hidden" id="quantity" name="quantity" value="">
        <input type="hidden" id="selected_price" name="selected_price" value="">

    {% else %}

        <!-- ===== Étape 1 : Choisir l’offre ===== -->
        <div class="step step-1 is-active" aria-labelledby="step1-title">
            <p id="step1-title" class="step1-title">{% trans "Choisissez votre offre" %}</p>

            <div class="offers" role="radiogroup" aria-label="{% trans 'Options' %}">
                {% for offer in offers %}
                    <label class="offer">
                        <!-- Radio -->
                        <input class="offer-radio" type="radio" name="offer_choice"
                               value="{{ offer.key }}"
                               {% if offer.is_default %}checked{% elif not default_offer and forloop.first %}checked{% endif %}
                               data-label="{{ offer.get_label }}"
                               data-qty="{{ offer.quantity }}"
                               data-price="{{ offer.price|unlocalize }}"
                               data-compare="{{ offer.compare_at_price|default:''|unlocalize }}">

                        <!-- Carte -->
                        <div class="offer-card {% if offer.quantity > 1 %}is-pack{% endif %}">
              <span class="offer-ic" aria-hidden="true">
                {% if offer.quantity == 1 %}<i class="fas fa-user"></i>
                {% elif offer.quantity == 2 %}<i class="fas fa-layer-group"></i>
                {% else %}<i class="fas fa-boxes"></i>{% endif %}
              </span>

                            <div class="offer-txt">
                                <div class="offer-title">{{ offer.get_label }}</div>

                                <div class="offer-price">
                                    <span class="now">{{ offer.price|floatformat:0|intcomma }} {% trans "Dhs" %}</span>
                                    {% if offer.compare_at_price and offer.compare_at_price > offer.price %}
                                        <span class="was">{{ offer.compare_at_price|floatformat:0|intcomma }} {% trans "Dhs" %}</span>
                                    {% endif %}
                                </div>

                                {% if offer.compare_at_price and offer.compare_at_price > offer.price %}
                                    {% with saved=offer.compare_at_price|save_amount:offer.price pct=offer.compare_at_price|discount_pct:offer.price %}
                                        {% if saved %}
                                            <div class="offer-save">
                                                <i class="fas fa-tags" aria-hidden="true"></i>
                                                <span>
                          {% trans "Économisez" %} {{ saved|intcomma }} {% trans "Dhs" %}
                          <span class="pct">(-{{ pct }}%)</span>
                        </span>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}

                                {% if offer.quantity > 1 %}
                                    <div class="offer-unit js-unit"
                                         data-price="{{ offer.price }}"
                                         data-qty="{{ offer.quantity }}"></div>
                                {% endif %}
                            </div>

                            <span class="offer-check" aria-hidden="true">
                <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                  <path d="M20.285 6.709a1 1 0 0 1 0 1.414l-9.192 9.192a1 1 0 0 1-1.414 0L3.715 11.55a1 1 0 1 1 1.414-1.415l5.05 5.05 8.485-8.485a1 1 0 0 1 1.621.009z"></path>
                </svg>
              </span>

                            {% if offer.is_default %}
                                <span class="offer-badge"><i class="fas fa-star"
                                                             aria-hidden="true"></i> {% trans "Meilleur choix" %}</span>
                            {% endif %}
                        </div>
                    </label>
                {% endfor %}
            </div>

            <!-- Champs techniques remplis par JS -->
            <input type="hidden" name="offer_key" id="offer_key" value="">
            <input type="hidden" name="quantity" id="quantity" value="">
            <input type="hidden" name="selected_price" id="selected_price" value="">

            <p class="help" style="text-align:center;margin:.6rem 0 0">
                <i class="fas fa-lightbulb" style="color:var(--warning)" aria-hidden="true"></i>
                {% trans "Astuce : parfait pour offrir à un proche tout en économisant." %}
            </p>

            <div style="display:flex;gap:.6rem;margin-top:.9rem">
                <button type="button" class="btn-cta" id="btn-continue">
                    <i class="fas fa-arrow-right" aria-hidden="true"></i>
                    <span id="cta-continue-text">{% trans "Continuer" %}</span>
                </button>
            </div>
        </div>

        <!-- ===== Étape 2 : Infos + validation ===== -->
        <div class="step step-2" aria-live="polite">
            <div class="recap" aria-live="polite">
                <span class="ic"><i class="fas fa-receipt" aria-hidden="true"></i></span>
                <span id="recap-text">{% trans "Veuillez choisir une offre" %}</span>
                <button type="button" class="link-back" id="link-back">
                    <i class="fas fa-arrow-left" aria-hidden="true"></i> {% trans "Modifier l’offre" %}
                </button>
            </div>

            <div class="grid">
                {% trans "Amine" as ph_name %}
                {% trans "06 12 34 56 78 ou +212 6 12 34 56 78 (WhatsApp)" as ph_phone %}
                {% trans "10 rue Anfa, Résidence Atlas, 3e étage, Casablanca" as ph_addr %}

                <div class="field">
                    <label for="firstname">{% trans "Votre prénom pour la remise" %}</label>
                    <div class="pill"><span class="icon"><i class="fas fa-user"></i></span>
                        {% render_field form.full_name id="firstname" placeholder=ph_name autocomplete="name" class+="form-control" %}
                    </div>
                </div>

                <div class="field">
                    <label for="phone-number">{% trans "Téléphone ou WhatsApp" %}</label>
                    <div class="pill"><span class="icon"><i class="fas fa-phone"></i></span>
                        {% render_field form.phone_number id="phone-number" placeholder=ph_phone autocomplete="tel" inputmode="tel" dir="ltr" pattern="^[0-9+()\-\\s]{6,}$" class+="form-control" %}
                    </div>
                    <p class="help">{% trans "Numéro utilisé uniquement pour confirmer la livraison (pas de spam)." %}</p>
                </div>

                <div class="field span-2">
                    <label for="address">{% trans "Votre adresse de livraison" %}</label>
                    <div class="pill"><span class="icon"><i class="fas fa-location-dot"></i></span>
                        <input type="text" name="address" id="address" class="form-control" placeholder="{{ ph_addr }}"
                               autocomplete="street-address" required>
                    </div>
                    <p class="help">{% trans "Données protégées (RGPD)" %}</p>
                </div>

                <input type="hidden" name="product_id" id="product_id" value="{{ product.pk }}">
                <input type="hidden" name="promotion_selected" id="promotion_selected"
                       value="{{ product.promotion_price|default_if_none:'' }}">
            </div>

            <button type="submit" class="btn-cta" id="submit-order">
                <i class="fas fa-bag-shopping" aria-hidden="true"></i> {% trans "Confirmer — Paiement à la livraison" %}
            </button>

            <div class="reassure-line mt-2" role="list" aria-label="{% trans 'Garanties & assistance' %}">
                <div class="reassure-item" role="listitem"><i class="fas fa-truck"
                                                              aria-hidden="true"></i><span>{% trans "Livraison gratuite" %}</span>
                </div>
                <div class="reassure-item" role="listitem"><i class="fas fa-shield-alt"
                                                              aria-hidden="true"></i><span>{% trans "Paiement à la livraison" %}</span>
                </div>
                <div class="reassure-item" role="listitem"><i class="fas fa-undo-alt"
                                                              aria-hidden="true"></i><span>{% trans "Retour 7 jours" %}</span>
                </div>
                <a class="reassure-item" role="listitem" href="https://wa.me/212625113848" target="_blank"
                   rel="noopener">
                    <i class="fab fa-whatsapp" aria-hidden="true"></i><span>{% trans "Support WhatsApp" %}</span>
                </a>
            </div>

            <p class="help" style="text-align:center;margin-top:.5rem">⭐ 4.7/5
                — {% trans "+1000 clients satisfaits" %}</p>
        </div>
    {% endif %}
</form>

<script>
    (function () {
        const form = document.getElementById('lead-form');
        if (!form) return;

        const hasOffers = form.getAttribute('data-has-offers') === '1';
        if (!hasOffers) return;

        // Éléments
        const step1 = form.querySelector('.step-1');
        const step2 = form.querySelector('.step-2');
        const radios = Array.from(form.querySelectorAll('.offer-radio'));
        const recap = document.getElementById('recap-text');
        const btnContinue = document.getElementById('btn-continue');
        const ctaText = document.getElementById('cta-continue-text');
        const backLink = document.getElementById('link-back');

        const inpKey = document.getElementById('offer_key');
        const inpQty = document.getElementById('quantity');
        const inpPrice = document.getElementById('selected_price');

           // Convertit toute string "locale" en nombre sûr
        const toNum = (v) => {
            if (v == null) return 0;
            const s = String(v)
                .replace(/\u00A0/g, '')   // espace insécable
                .replace(/\s/g, '')       // autres espaces
                .replace(',', '.')        // virgule décimale -> point
                .replace(/[^\d.-]/g, ''); // suppr. tout sauf chiffres . -
            const n = Number(s);
            return Number.isFinite(n) ? n : 0;
        };

        // Format monétaire (fr-MA-like) sans décimales
        const fmt = (n) => {
            try {
                return new Intl.NumberFormat('{{ LANGUAGE_CODE|default:"fr" }}', {maximumFractionDigits: 0}).format(Number(n));
            } catch (e) {
                return String(Math.round(Number(n) || 0));
            }
        };

        // Prix unitaire (packs)
        form.querySelectorAll('.js-unit').forEach(el => {
            const p = Number(el.dataset.price || 0), q = toNum(el.dataset.qty || 1);
            if (q > 1 && p > 0) {
                const unit = Math.round((p / q) * 2) / 2; // arrondi 0.5
                el.textContent = `≈ ${fmt(unit)} Dhs / {% trans "tapis" %}`;
            }
        });

        const current = () => radios.find(r => r.checked);

        function applySelection(r) {
            if (!r) return;
            const key = r.value;
            const qty = r.dataset.qty || '';
            const price = toNum(r.dataset.price) || '';
            const label = r.dataset.label || '';

            inpKey.value = key;
            inpQty.value = qty;
            inpPrice.value = price

            if (recap) {
                recap.textContent = `{% trans "Vous avez choisi :" %} ${qty} {% trans "à" %} ${fmt(price)} Dhs`;
            }
            if (ctaText) {
                const short = label.replace(/\s*\(.*?\)\s*/, ''); // retire "(Meilleur choix)"
                ctaText.textContent = `{% trans "Continuer avec l’offre" %} ${short}`;
            }
        }

        // Init
        applySelection(current());

        // Écoutes
        radios.forEach(r => {
            r.addEventListener('change', () => applySelection(r));
            r.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applySelection(r);
                }
            });
        });

        // Navigation
        if (btnContinue) {
            btnContinue.addEventListener('click', () => {
                if (!inpKey.value || !inpQty.value || !inpPrice.value) {
                    try {
                        Swal.fire({
                            icon: 'warning',
                            title: '{% trans "Choix requis" %}',
                            text: '{% trans "Veuillez sélectionner une offre pour continuer." %}'
                        });
                    } catch (e) {
                        alert('{% trans "Veuillez sélectionner une offre pour continuer." %}');
                    }
                    return;
                }
                step1.classList.remove('is-active');
                step2.classList.add('is-active');
                const first = document.getElementById('firstname');
                if (first) try {
                    first.focus();
                } catch (e) {
                }
            });
        }

        if (backLink) {
            backLink.addEventListener('click', () => {
                step2.classList.remove('is-active');
                step1.classList.add('is-active');
            });
        }

        // Sécurité soumission
        form.addEventListener('submit', function (e) {
            if (!inpKey.value || !inpQty.value || !inpPrice.value) {
                e.preventDefault();
                try {
                    Swal.fire({
                        icon: 'error',
                        title: '{% trans "Offre manquante" %}',
                        text: '{% trans "Merci de sélectionner une offre avant de confirmer." %}'
                    });
                } catch (err) {
                    alert('{% trans "Merci de sélectionner une offre avant de confirmer." %}');
                }
            }
        });
    })();
</script>
