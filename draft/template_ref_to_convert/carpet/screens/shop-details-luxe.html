{% extends 'carpet/base.html' %}
{% load i18n static %}
{% get_current_language as LANGUAGE_CODE %}

{% block title %}Tapis de Prière - Maroc{% endblock title %}

{% block extra_css %}
    <style>
        /* ====== TOKENS NOIR & OR ====== */
        :root {
            --bg: #0b0b0c; /* body */
            --surface: #111215; /* cartes/panneaux */
            --surface-2: #16181a; /* champs / hover */
            --text: #f2f2f2; /* texte principal */
            --muted: #b7b7bd; /* texte secondaire */
            --gold: #d4af37; /* or principal */
            --gold-2: #c19a2b; /* or hover/ombre */
            --ring: rgba(212, 175, 55, .35);
            --bd: rgba(212, 175, 55, .22); /* bordures subtiles */
            --shadow: 0 10px 30px rgba(0, 0, 0, .45);
            --radius: 18px;
        }

        /* ====== FOND GLOBAL & TYPO ====== */
        html, body {
            background: var(--bg);
            color: var(--text);
        }

        a {
            color: var(--gold);
            text-decoration: none;
        }

        a:hover {
            color: #f1d27a;
        }

        .ul-inner-page-container {
            max-width: 1120px;
        }

        /* ====== BARRE MARQUE / HEADER ====== */
        .brandbar {
            background: var(--surface);
            border: 1px solid var(--bd);
            box-shadow: var(--shadow);
        }

        .brandbar .brand-tagline {
            color: var(--muted);
        }

        .brandbar .btn-whatsapp {
            background: var(--surface-2);
            color: var(--text);
            border: 1px solid var(--bd);
        }

        .brandbar .btn-whatsapp i {
            color: #2bd87f;
        }

        /* ====== BOUTONS (CTA) ====== */
        .btn, .lp-form .btn-cta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: .5rem;
            padding: .85rem 1.1rem;
            border-radius: 12px;
            font-weight: 700;
            border: 0;
            transition: transform .05s ease, filter .2s ease, background .2s ease;
        }

        .btn-primary, .lp-form .btn-cta {
            background: var(--gold);
            color: #111;
        }

        .btn-primary:hover, .lp-form .btn-cta:hover {
            filter: brightness(1.05);
        }

        .btn-primary:active, .lp-form .btn-cta:active {
            transform: translateY(1px);
        }

        .btn-outline-dark {
            color: var(--text);
            background: transparent;
            border: 1px solid var(--bd);
        }

        .btn-outline-dark:hover {
            background: var(--surface-2);
        }

        /* ====== BADGES ====== */
        .badge-list {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem .75rem;
            align-items: center;
        }

        .badge-list .badge {
            background: rgba(212, 175, 55, .10);
            color: var(--gold);
            border: 1px solid var(--bd);
            font-weight: 600;
        }

        /* ====== FORM (pills) ====== */
        .lp-form {
            --pill-bg: var(--surface-2);
            --pill-bd: var(--bd);
            --pill-bd-focus: var(--gold);
            --pill-txt: var(--text);
            --pill-ph: #9ca3af;
        }

        .lp-form .field label {
            color: var(--muted);
        }

        .lp-form .pill {
            background: var(--pill-bg);
            border: 1px solid var(--pill-bd);
        }

        .lp-form .pill:focus-within {
            border-color: var(--gold);
            box-shadow: 0 0 0 .2rem var(--ring);
        }

        .lp-form .icon {
            color: var(--gold);
        }

        .lp-form .help {
            color: var(--muted);
        }

        .lp-form .badge-sale {
            background: transparent;
            border: 1px solid var(--bd);
            color: var(--gold);
        }

        .lp-form .error {
            color: #ff6b6b;
        }

        /* ====== RÉASSURANCE (pills) ====== */
        .reassure-line {
            gap: .5rem .75rem;
        }

        .reassure-item {
            background: rgba(212, 175, 55, .10);
            color: var(--gold);
            border: 1px solid var(--bd);
            font-weight: 600;
        }

        .reassure-item i {
            color: var(--gold);
        }

        /* ====== ACCORDÉONS (FAQ / mini-FAQ) ====== */
        .ul-accordion .ul-single-accordion-item__header {
            background: var(--surface);
            border: 1px solid var(--bd);
            color: var(--text);
        }

        .ul-accordion .ul-single-accordion-item__body {
            background: var(--surface-2);
            border: 1px solid var(--bd);
            color: var(--muted);
        }

        .ul-accordion .icon i {
            color: var(--gold);
        }

        /* ====== PRIX / AIDES ====== */
        .ul-product-details-price .fs-4 {
            color: var(--gold);
        }

        .ul-product-details-price-helper {
            color: var(--muted);
        }

        .ul-product-details-savings-helper {
            color: #26a269;
        }

        /* ====== CARTES / PANNEAUX ====== */
        .card, .panel, .ul-blog-big blockquote, .quote-card {
            background: var(--surface);
            border: 1px solid var(--bd);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        /* ====== RTL ====== */
        {% if LANGUAGE_CODE == 'ar' %}
            .brandbar, .lp-form, .ul-accordion, .quote-luxe {
                direction: rtl;
            }
        {% endif %}
    </style>

{% endblock extra_css %}


{% block extra_head %}

    <script type="application/ld+json">
        {
          "@context":"https://schema.org",
          "@type":"Product",
          "name":"Tapis Sajadat Al-Raha",
          "image":[
            "/static/carpet/images/cover/cadre-domestique.webp"
          ],
          "description":"Tapis de prière avec coussin mémoire 2 cm, base antiglisse, velours doux.",
          "brand":{"@type":"Brand","name":"Al-Raha"},
          "offers":{"@type":"Offer","priceCurrency":"MAD","price":"{{ product.promotion_price|floatformat:0 }}","availability":"https://schema.org/InStock"},
  "aggregateRating":{"@type":"AggregateRating","ratingValue":"4.9","reviewCount":1000}
}
    </script>

{% endblock extra_head %}


{% block content %}
    {#    {% include 'carpet/components/sidebar/sidebar.html' %}#}
    {% include 'carpet/components/header/header-luxe.html' %}
    {% include 'carpet/components/logo/logo-luxe.html' %}
    {% include 'carpet/components/quote/quote-luxe.html' %}
    {% include 'carpet/components/product/product-luxe.html' %}
    {% include 'carpet/components/credibility/credibility-luxe.html' %}
    {% include 'carpet/components/reviews/reviews-luxe.html' %}







{% endblock content %}
<!-- Optionnel pour lightbox -->

{% block js %}


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('lead-form');
            if (!form) return;

            const submitBtn = form.querySelector('[type="submit"]');
            const url = "{% url 'create-lead' %}";

            function getCSRFTOKEN() {
                const inp = document.querySelector('[name=csrfmiddlewaretoken]');
                return inp ? inp.value : '';
            }

            function sanitizePhone(t) {
                return String(t || '').trim().replace(/\s+/g, '').replace(/[^\d+]/g, '').replace(/^00/, '+');
            }

            function setLoading(x) {
                if (!submitBtn) return;
                submitBtn.disabled = x;
                submitBtn.innerHTML = x ? 'Envoi…' : (submitBtn.dataset._txt || 'Envoyer');
            }

            submitBtn && (submitBtn.dataset._txt = submitBtn.innerHTML);

            function validate() {
                const fullNameEl = document.getElementById('firstname');
                const phoneEl = document.getElementById('phone-number');

                // Accepte product_id OU id_product (champ du ModelForm)
                const productEl = document.getElementById('product_id') || document.getElementById('id_product');
                const promoEl = document.getElementById('promotion_selected') || document.getElementById('id_promotion_selected');

                [fullNameEl, phoneEl].forEach(el => el && el.classList.remove('is-invalid'));

                let ok = true, errs = [];

                if (!fullNameEl || fullNameEl.value.trim().length < 2) {
                    ok = false;
                    errs.push('Veuillez saisir votre prénom.');
                    fullNameEl && fullNameEl.classList.add('is-invalid');
                }
                if (!phoneEl) {
                    ok = false;
                    errs.push('Champ téléphone manquant.');
                } else {
                    phoneEl.value = sanitizePhone(phoneEl.value);
                    if (phoneEl.value.length < 6) {
                        ok = false;
                        errs.push('Numéro de téléphone invalide.');
                        phoneEl.classList.add('is-invalid');
                    }
                }
                if (!productEl || !productEl.value) {
                    ok = false;
                    errs.push('Produit introuvable (champ "product" manquant).');
                }
                if (!promoEl) {
                    ok = false;
                    errs.push('promotion_selected manquant.');
                }

                return {ok, errs};
            }

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const {ok, errs} = validate();
                if (!ok) {
                    Swal.fire({icon: 'error', title: 'Erreur', text: errs.join('\n')});
                    return;
                }

                setLoading(true);
                const csrftoken = getCSRFTOKEN();
                const formData = new FormData(form);

                fetch(url, {method: 'POST', headers: {'X-CSRFToken': csrftoken}, body: formData})
                    .then(async resp => ({status: resp.status, body: await resp.json().catch(() => ({}))}))
                    .then(({status, body}) => {
                        if (status === 200 && body.status === 'ok' && body.redirect_url) {
                            window.location.href = body.redirect_url;
                        } else {
                            const lines = [];
                            Object.entries(body.errors || {}).forEach(([f, arr]) => (arr || []).forEach(e => lines.push(`${f}: ${e.message || e}`)));
                            Swal.fire({
                                icon: 'error',
                                title: 'Erreur',
                                text: lines.join('\n') || 'Merci de corriger le formulaire.'
                            });
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        Swal.fire({
                            icon: 'error',
                            title: 'Erreur réseau',
                            text: 'Impossible de soumettre votre demande.'
                        });
                    })
                    .finally(() => setLoading(false));
            });

            const el = document.querySelector('.brandbar');
            if (!el) return;
            if (window.scrollY > 40) {
                el.classList.add('is-shrink');
            } else {
                el.classList.remove('is-shrink');
            }

            {#----------------------------------------------------------------------------------------------- #}
            const wrap = document.getElementById('product-hero');
            const heroImg = document.getElementById('hero-img');
            const heroLink = document.getElementById('hero-link');
            if (!wrap || !heroImg) return;

            let thumbsBox = wrap.querySelector('.phl-thumbs');
            const btnPrev = wrap.querySelector('.prev');
            const btnNext = wrap.querySelector('.next');

            // ---- utils ----
            const toArray = (x) => {
                if (!x) return [];
                if (Array.isArray(x)) return x;
                if (typeof x === 'string') {
                    try {
                        return JSON.parse(x);
                    } catch {
                        return [];
                    }
                }
                // NodeList/HTMLCollection
                if (typeof x.length === 'number' && typeof x.item === 'function') return Array.prototype.slice.call(x);
                return [];
            };
            const parseJsonScript = (id) => {
                const tag = document.getElementById(id);
                if (!tag) return [];
                try {
                    return JSON.parse(tag.textContent || '[]');
                } catch {
                    return [];
                }
            };

            // ---- gather images: DOM → JSON tag → fallback ----
            let images = [];
            if (thumbsBox) {
                const nodes = thumbsBox.querySelectorAll('.phl-thumb');
                images = toArray(nodes).map(b => ({src: b.dataset.full, alt: b.dataset.alt || ''}));
            }
            if (!images.length) images = parseJsonScript('phl-images-data');
            if (!Array.isArray(images)) images = [];
            if (!images.length) {
                images = [
                    {src: "{% static 'carpet/images/cover/cadre-domestique.webp' %}", alt: "Vue principale du tapis"},
                    {
                        src: "{% static 'carpet/images/cover/mouse-memoire-airgel.webp' %}",
                        alt: "Schéma coussin mémoire intégré"
                    },
                    {src: "{% static 'carpet/images/cover/genous-coussin.webp' %}", alt: "Coussin mémoire — gros plan"},
                    {src: "{% static 'carpet/images/cover/toucher.webp' %}", alt: "Texture et toucher du tapis"},
                    {src: "{% static 'carpet/images/cover/image-profil.webp' %}", alt: "Vue d’ensemble du tapis"}
                ];
            }

            // Build thumbs if missing
            if (!thumbsBox) {
                thumbsBox = document.createElement('div');
                thumbsBox.className = 'phl-thumbs';
                wrap.appendChild(thumbsBox);
            }
            if (!thumbsBox.querySelector('.phl-thumb')) {
                const frag = document.createDocumentFragment();
                images.forEach((m, i) => {
                    const b = document.createElement('button');
                    b.type = 'button';
                    b.className = 'phl-thumb' + (i === 0 ? ' phl-thumb--sel' : '');
                    b.setAttribute('role', 'tab');
                    b.setAttribute('aria-selected', i === 0 ? 'true' : 'false');
                    b.setAttribute('aria-controls', 'hero-img');
                    b.dataset.index = String(i);
                    b.dataset.full = m.src;
                    b.dataset.alt = m.alt || '';
                    const im = document.createElement('img');
                    im.src = m.src;
                    im.alt = '';
                    b.appendChild(im);
                    frag.appendChild(b);
                });
                thumbsBox.appendChild(frag);
            }

            // State
            let thumbs = Array.prototype.slice.call(thumbsBox.querySelectorAll('.phl-thumb'));
            let current = Math.max(0, thumbs.findIndex(t => t.classList.contains('phl-thumb--sel')));
            if (current < 0) current = 0;

            function swapTo(src, alt) {
                heroImg.classList.add('is-fading');
                const onLoaded = () => {
                    heroImg.classList.remove('is-fading');
                    heroImg.removeEventListener('load', onLoaded);
                };
                heroImg.addEventListener('load', onLoaded, {once: true});
                heroImg.src = src;
                heroImg.alt = alt || heroImg.alt;
                if (heroLink) heroLink.href = src;
            }

            function setSelected(i) {
                if (!thumbs.length) return;
                current = (i + thumbs.length) % thumbs.length;
                thumbs.forEach(t => {
                    t.classList.remove('phl-thumb--sel');
                    t.setAttribute('aria-selected', 'false');
                });
                const btn = thumbs[current];
                btn.classList.add('phl-thumb--sel');
                btn.setAttribute('aria-selected', 'true');
                try {
                    btn.scrollIntoView({block: 'nearest', inline: 'center', behavior: 'smooth'});
                } catch {
                }
                swapTo(btn.dataset.full, btn.dataset.alt);
            }

            // Ensure hero has an image
            if (!heroImg.getAttribute('src') && images[0]) swapTo(images[0].src, images[0].alt);

            // Listeners
            thumbsBox.addEventListener('click', (e) => {
                const b = e.target.closest('.phl-thumb');
                if (!b) return;
                const i = Number.parseInt(b.dataset.index, 10);
                setSelected(Number.isFinite(i) ? i : thumbs.indexOf(b));
            });
            btnPrev && btnPrev.addEventListener('click', () => setSelected(current - 1));
            btnNext && btnNext.addEventListener('click', () => setSelected(current + 1));

            const root = document.querySelector('.product-hero-luxe');
            const isRTL = root && root.classList.contains('rtl');

            // Clavier (← →) avec inversion en RTL
            document.addEventListener('keydown', function (e) {
                if (e.key === 'ArrowLeft') {
                    isRTL ? setSelected(current + 1) : setSelected(current - 1);
                }
                if (e.key === 'ArrowRight') {
                    isRTL ? setSelected(current - 1) : setSelected(current + 1);
                }

                const wrap = document.querySelector('.rev-ugc');
                const isRTL = wrap?.classList.contains('rtl');

                track.addEventListener('keydown', (e) => {
                    if (!isRTL) {
                        if (e.key === 'ArrowLeft') {
                            e.preventDefault();
                            go(-1);
                        }
                        if (e.key === 'ArrowRight') {
                            e.preventDefault();
                            go(1);
                        }
                    } else {
                        if (e.key === 'ArrowLeft') {
                            e.preventDefault();
                            go(1);
                        } // en RTL, gauche = “suivant”
                        if (e.key === 'ArrowRight') {
                            e.preventDefault();
                            go(-1);
                        } // en RTL, droite = “précédent”
                    }
                });

            });

            // Swipe mobile avec inversion en RTL
            (function enableSwipe(el) {
                if (!el) return;
                let startX = 0, dist = 0, active = false;
                el.addEventListener('touchstart', (e) => {
                    if (!e.touches[0]) return;
                    active = true;
                    startX = e.touches[0].clientX;
                    dist = 0;
                }, {passive: true});
                el.addEventListener('touchmove', (e) => {
                    if (!active || !e.touches[0]) return;
                    dist = e.touches[0].clientX - startX;
                }, {passive: true});
                el.addEventListener('touchend', () => {
                    if (!active) return;
                    active = false;
                    if (Math.abs(dist) > 30) {
                        if (isRTL) {
                            // en RTL : glisser à gauche => image précédente
                            dist < 0 ? setSelected(current - 1) : setSelected(current + 1);
                        } else {
                            // en LTR : glisser à gauche => image suivante
                            dist < 0 ? setSelected(current + 1) : setSelected(current - 1);
                        }
                    }
                });
            })(wrap.querySelector('.phl-figure'));
            {# --------------------------------------------------------------------------------------------- #}
            const faq = document.getElementById('cta-mini-faq');
            if (faq) {
                faq.addEventListener('click', function (e) {
                    const header = e.target.closest('.phl-acc__h');
                    if (!header) return;

                    const bodyId = header.getAttribute('aria-controls');
                    const body = document.getElementById(bodyId);
                    const expanded = header.getAttribute('aria-expanded') === 'true';

                    // si tu veux un accordéon "une seule ouverte", décommente le bloc suivant
                    // faq.querySelectorAll('.phl-acc__h[aria-expanded="true"]').forEach(h => {
                    //   if (h !== header) {
                    //     h.setAttribute('aria-expanded', 'false');
                    //     const b = document.getElementById(h.getAttribute('aria-controls'));
                    //     if (b) b.hidden = true;
                    //     const i = h.querySelector('.phl-acc__icon i');
                    //     if (i) { i.classList.add('flaticon-plus'); i.classList.remove('flaticon-minus'); }
                    //   }
                    // });

                    header.setAttribute('aria-expanded', String(!expanded));
                    if (body) body.hidden = expanded;

                    const icon = header.querySelector('.phl-acc__icon i');
                    if (icon) {
                        icon.classList.toggle('flaticon-plus', expanded);
                        icon.classList.toggle('flaticon-minus', !expanded);
                    }
                });
            }


        });
    </script>

{% endblock js %}

{% block before_end_body %}
    <!-- Avant la fin de votre <body> -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock before_end_body %}